<!DOCTYPE html>
<html lang="en">

<head>
    <title>Honeypot Debugger</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f4f7f6;
            display: flex;
            height: 100vh;
            margin: 0;
        }

        #sidebar {
            width: 350px;
            background: #2c3e50;
            color: white;
            padding: 20px;
            overflow-y: auto;
        }

        #main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        #chat-box {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 20px;
            overflow-y: auto;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .msg {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            max-width: 80%;
        }

        .scammer {
            background: #e74c3c;
            color: white;
            align-self: flex-start;
        }

        .ramesh {
            background: #3498db;
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }

        .json-block {
            background: #000;
            color: #00ff00;
            padding: 10px;
            font-size: 12px;
            border-radius: 5px;
            white-space: pre-wrap;
            margin-top: 10px;
        }

        input {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        button {
            padding: 10px;
            background: #27ae60;
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 10px;
        }
    </style>
</head>

<body>

    <div id="sidebar">
        <h3>üîç Live Inspection</h3>

        <p><strong>Evidence Locker:</strong></p>
        <div id="intel-box" class="json-block" style="color: #00e5ff;">No evidence yet...</div>

        <div id="status-flag"
            style="margin-top: 10px; padding: 10px; border-radius: 5px; background: #444; text-align: center; font-weight: bold;">
            CALLBACK STATUS: PENDING
        </div>

        <hr>

        <p><strong>Last Sent Payload:</strong></p>
        <div id="input-json" class="json-block">Waiting...</div>

        <hr>

        <p><strong>Last Received JSON:</strong></p>
        <div id="output-json" class="json-block">Waiting...</div>
    </div>



    <div id="main">
        <h2>üë¥ Ramesh's Honeypot Interface</h2>
        <div id="chat-box"></div>
        <input type="text" id="user-input" placeholder="Type scammer message here (e.g. 'Your bank is blocked!')">
        <button onclick="sendMsg()">Send as Scammer</button>
    </div>

    <script>
        let history = [];
        let sessionId = "test-session-" + Math.floor(Math.random() * 1000);

        async function sendMsg() {
            const text = document.getElementById('user-input').value;
            if (!text) return;

            // 1. Display Scammer message in UI
            const chatBox = document.getElementById('chat-box');
            chatBox.innerHTML += `<div class="msg scammer"><strong>Scammer:</strong> ${text}</div>`;

            // 2. Prepare the Payload to send to your FastAPI
            const payload = {
                sessionId: sessionId,
                message: {
                    sender: "scammer",
                    text: text,
                    timestamp: new Date().toISOString()
                },
                conversationHistory: history,
                metadata: { channel: "WebTest", language: "English", locale: "IN" }
            };

            // Show the "Input JSON" in the sidebar
            document.getElementById('input-json').innerText = JSON.stringify(payload, null, 2);

            try {
                // 3. Call your Backend
                const response = await fetch('http://127.0.0.1:8000/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': 'tinku_local_test_key'
                    },
                    body: JSON.stringify(payload)
                });

                // 4. NOW define 'data' from the response
                const data = await response.json();

                // Show the raw Response JSON in the sidebar
                document.getElementById('output-json').innerText = JSON.stringify(data, null, 2);

                // 5. UPDATE THE EVIDENCE LOCKER (This is the part you just added)
                if (data.final_payload_preview) {
                    document.getElementById('intel-box').innerText = JSON.stringify(data.final_payload_preview, null, 2);
                }

                // 6. Update the Status Flag
                const statusFlag = document.getElementById('status-flag');
                if (data.report_triggered) {
                    statusFlag.innerText = "‚úÖ FINAL CALLBACK SENT";
                    statusFlag.style.background = "#27ae60";
                } else {
                    statusFlag.innerText = "‚è≥ GATHERING EVIDENCE...";
                    statusFlag.style.background = "#f39c12";
                }

                // 7. Display Ramesh's Reply
                chatBox.innerHTML += `<div class="msg ramesh"><strong>Ramesh:</strong> ${data.reply}</div>`;

                // 8. Update history for the next turn
                history.push({ sender: "scammer", text: text, timestamp: payload.message.timestamp });
                history.push({ sender: "user", text: data.reply, timestamp: new Date().toISOString() });

                // Clean up
                document.getElementById('user-input').value = "";
                chatBox.scrollTop = chatBox.scrollHeight;

            } catch (err) {
                console.error("Error calling API:", err);
                alert("API Error! Make sure FastAPI is running and CORS is enabled.");
            }
        }
    </script>
</body>

</html>